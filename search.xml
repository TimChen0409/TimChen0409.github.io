<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>在.NET Core MVC使用 ClosedXML 匯出Excel</title>
    <url>/2020/12/03/net-core-closedXML/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在後台常常需要有報表匯出Excel的功能，過往是使用<a href="https://github.com/nissl-lab/npoi">NPOI</a>去實作，近期專案決定使用另一套 Eecel 程式庫 ClosedXML，所以簡單練習紀錄一下</p>
<a id="more"></a>
<h2 id="新增-NET-Core-MVC專案"><a href="#新增-NET-Core-MVC專案" class="headerlink" title="新增.NET Core MVC專案"></a>新增.NET Core MVC專案</h2><p><img src="/img/20201203/ClosedXML1.png"></p>
<h2 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h2><p>工具列→專案→管理NuGet套件→瀏覽→搜尋輸入ClosedXML→安裝</p>
<p><img src="/img/20201203/ClosedXML2.png"></p>
<h2 id="新增Model-ProductController-和-View"><a href="#新增Model-ProductController-和-View" class="headerlink" title="新增Model , ProductController 和 View"></a>新增Model , ProductController 和 View</h2><p>新增Model,Controller 和 View，這邊不做資料庫等設定，直接產生資料與呈現。</p>
<p>Model：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Product</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> ProductName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">decimal</span> UnitPrice &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> Quantity &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Controller：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">ClosedXMLExample.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">private</span> List&lt;Product&gt; productList;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ProductController</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            productList = <span class="keyword">new</span> List&lt;Product&gt;() &#123;</span><br><span class="line">                <span class="keyword">new</span> Product&#123; Id=<span class="number">1</span>,ProductName=<span class="string">&quot;Apple&quot;</span>,UnitPrice=<span class="number">30.5</span>m,Quantity=<span class="number">4</span>&#125;,</span><br><span class="line">                <span class="keyword">new</span> Product&#123; Id=<span class="number">2</span>,ProductName=<span class="string">&quot;Banana&quot;</span>,UnitPrice=<span class="number">40</span>,Quantity=<span class="number">8</span>&#125;,</span><br><span class="line">                <span class="keyword">new</span> Product&#123; Id=<span class="number">3</span>,ProductName=<span class="string">&quot;Orange&quot;</span>,UnitPrice=<span class="number">20</span>,Quantity=<span class="number">10</span>&#125;,</span><br><span class="line">                <span class="keyword">new</span> Product&#123; Id=<span class="number">4</span>,ProductName=<span class="string">&quot;Watermelon&quot;</span>,UnitPrice=<span class="number">100</span>,Quantity=<span class="number">2</span>&#125;,</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> View(productList);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>檢視：</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">@model IEnumerable&lt;ClosedXMLExample.Models.Product&gt;</span><br><span class="line"></span><br><span class="line">@&#123;</span><br><span class="line">    ViewData[<span class="string">&quot;Title&quot;</span>] = <span class="string">&quot;Index&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;form method=<span class="string">&quot;post&quot;</span>&gt;</span><br><span class="line">    &lt;button <span class="keyword">class</span>=<span class="string">&quot;btn btn-danger&quot;</span>&gt;Export Excel&lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line">&lt;table <span class="keyword">class</span>=<span class="string">&quot;table&quot;</span>&gt;</span><br><span class="line">    &lt;thead&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;th&gt;</span><br><span class="line">                @Html.DisplayNameFor(model =&gt; model.Id)</span><br><span class="line">            &lt;/th&gt;</span><br><span class="line">            &lt;th&gt;</span><br><span class="line">                @Html.DisplayNameFor(model =&gt; model.ProductName)</span><br><span class="line">            &lt;/th&gt;</span><br><span class="line">            &lt;th&gt;</span><br><span class="line">                @Html.DisplayNameFor(model =&gt; model.UnitPrice)</span><br><span class="line">            &lt;/th&gt;</span><br><span class="line">            &lt;th&gt;</span><br><span class="line">                @Html.DisplayNameFor(model =&gt; model.Quantity)</span><br><span class="line">            &lt;/th&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">    &lt;/thead&gt;</span><br><span class="line">    &lt;tbody&gt;</span><br><span class="line">        @foreach (<span class="keyword">var</span> item <span class="keyword">in</span> Model)</span><br><span class="line">        &#123;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;</span><br><span class="line">                    @Html.DisplayFor(modelItem =&gt; item.Id)</span><br><span class="line">                &lt;/td&gt;</span><br><span class="line">                &lt;td&gt;</span><br><span class="line">                    @Html.DisplayFor(modelItem =&gt; item.ProductName)</span><br><span class="line">                &lt;/td&gt;</span><br><span class="line">                &lt;td&gt;</span><br><span class="line">                    @Html.DisplayFor(modelItem =&gt; item.UnitPrice)</span><br><span class="line">                &lt;/td&gt;</span><br><span class="line">                &lt;td&gt;</span><br><span class="line">                    @Html.DisplayFor(modelItem =&gt; item.Quantity)</span><br><span class="line">                &lt;/td&gt;</span><br><span class="line">            &lt;/tr&gt;</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/tbody&gt;</span><br><span class="line">&lt;/table&gt;</span><br></pre></td></tr></table></figure>

<p>到這邊前置作業就結束，到這邊可以看到網頁可以顯示商品銷售資料，並新增一顆匯出Excel按鈕。</p>
<p><img src="/img/20201203/ClosedXML3.png"></p>
<h2 id="實作方法"><a href="#實作方法" class="headerlink" title="實作方法"></a>實作方法</h2><p>之後至ProductController 引用命名空間並 新增Action</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> ClosedXML.Excel;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">ExportExcel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//取得欄位名稱</span></span><br><span class="line">    <span class="keyword">var</span> columnNameList = <span class="keyword">typeof</span>(Product).GetProperties().Select(c =&gt; c.Name).ToList();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> contentType = <span class="string">&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;</span>;</span><br><span class="line">    <span class="built_in">string</span> fileName = <span class="string">&quot;ProductsReport.xlsx&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//建立Excel</span></span><br><span class="line">    <span class="keyword">var</span> workbook = <span class="keyword">new</span> XLWorkbook();</span><br><span class="line">    IXLWorksheet worksheet = workbook.Worksheets.Add(<span class="string">&quot;ProductsSale&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//設定標題列名稱與樣式</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">1</span>; i &lt;= columnNameList.Count(); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        worksheet.Cell(<span class="number">1</span>, i).Value = columnNameList[i - <span class="number">1</span>];</span><br><span class="line">        worksheet.Cell(<span class="number">1</span>, i).Style.Fill.SetBackgroundColor(XLColor.Red);</span><br><span class="line">        worksheet.Cell(<span class="number">1</span>, i).Style.Font.SetFontSize(<span class="number">12</span>);</span><br><span class="line">        worksheet.Cell(<span class="number">1</span>, i).Style.Font.SetBold();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">1</span>; j &lt;= productList.Count(); j++)</span><br><span class="line">    &#123;</span><br><span class="line">        worksheet.Cell(j + <span class="number">1</span>, <span class="number">1</span>).Value = productList[j - <span class="number">1</span>].Id;</span><br><span class="line">        worksheet.Cell(j + <span class="number">1</span>, <span class="number">2</span>).Value = productList[j - <span class="number">1</span>].ProductName;</span><br><span class="line">        worksheet.Cell(j + <span class="number">1</span>, <span class="number">3</span>).Value = productList[j - <span class="number">1</span>].UnitPrice;</span><br><span class="line">        worksheet.Cell(j + <span class="number">1</span>, <span class="number">4</span>).Value = productList[j - <span class="number">1</span>].Quantity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//寫入檔案</span></span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> stream = <span class="keyword">new</span> MemoryStream())</span><br><span class="line">    &#123;</span><br><span class="line">        workbook.SaveAs(stream);</span><br><span class="line">        <span class="keyword">var</span> content = stream.ToArray();</span><br><span class="line">        <span class="keyword">return</span> File(content, contentType, fileName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>並調整View裡面按鈕的部份。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">&lt;form method=<span class="string">&quot;post&quot;</span>&gt;</span><br><span class="line">    &lt;button <span class="keyword">class</span>=<span class="string">&quot;btn btn-danger&quot;</span> asp-action=<span class="string">&quot;ExportExcel&quot;</span>&gt;Export Excel&lt;/button&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>

<p>之後點選按鈕匯出結果如下：</p>
<p><img src="/img/20201203/ClosedXML4.png"></p>
]]></content>
      <categories>
        <category>.NetCore</category>
      </categories>
      <tags>
        <tag>.NET Core</tag>
        <tag>Back-end</tag>
      </tags>
  </entry>
</search>
